# Procedual Skeleton Deduction in Animation/程序化骨骼动画LOD生成

本研究旨在开发一种方法，用于在生成LOD动画时尽可能减少骨骼和蒙皮的数量，以降低动画的计算负担。考虑到直接删除骨骼可能导致计算错误，本方案采取的策略是解除骨骼与顶点的绑定，而非移动实际的骨骼。

## 研究方案

基于Maya搭建了一个脚本系统，实现对于每个maya文件，自动完成以下操作。该脚本能够根据设定的阈值和迭代次数，选择出可以删除的骨骼，并得到最终的简化版动画。

操作大纲如下：

1. 将骨骼数据转化为树状结构
    1. 建树时，对于每一根骨骼，计算和它绑定的所有节点所围成的体积云大小，将该值作为权重
    2. 确定pelvis/Hips将其作为根节点，同时设置一系列不能被删除的骨骼；
    3. 对骨骼树进行层次遍历，得到一个数组，后续在数组上进行贪心计算；

2. 得到初始LOD动画
    1. 利用原始的模型生成LOD，记为LOD_init；
    2. 进行截图/渲染；

3. 初筛
    1. 进行后序遍历，对于每一根骨骼，判断它和父节点之间的相对位移，如果相对位移接近于0，那么可以把其绑定的点的权重全部赋给其父节点
    2. 对于1中设置的不能删除的骨骼，也移出待判断列表

4. 确定一个threshold， 对于每一轮循环
    1. 删除单根骨骼对应的权重，并生成LOD，渲染相应的动画
    2. 利用评估算法评估删除每根骨骼对动画质量的影响。
    3. 排序：根据质量损失与权重的比率对骨骼进行排序。这个比率表示每单位权重损失的质量损失。
    4. 从比率最小的骨骼开始，选择骨骼进行删除同时删除权重；
    5. 重复步骤，直到达到阈值不能再进行循环

5. 根据得到的最终骨骼列表，生成简化版的LOD动画。

## 环境配置

动捕原始数据是fbx的格式，而我们需要的是fbx文件中的骨骼和动画部分。

- python version：3.7

- python sdk：https://github.com/Shiiho11/FBX-Python-SDK-for-Python3.x

- 下载对应的2020.0.1_3.7.6_x64文件夹，放入python目录/Libs/site-packages下，并新建一个名为fbx的空文件夹，即可在python中正常使用fbx库。

## 使用方法

1. 确定maya场景动画中的骨骼，导出为fbx文件。
2. 更改skeleton_tree.py第295行的fbx文件存储地址。
3. 更改render_animation第76行摄像机参数文件的存储地址、153行的输出结果存储地址。
4. 更改main.py第74-79行中的参数设置，目前的图像输出方式是截图，如果想更改为渲染模式，可以将main.py文件中的get_screenshot函数更改为render_anim函数（同时需要更改传入参数，以及渲染的输出地址）。
5. 在maya的python环境中运行main.py，会自动进行骨骼删减并输出删减比例。